<div class="min-h-screen bg-gray-50">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <svg class="h-8 w-8 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
        </svg>
        <h1 class="ml-3 text-2xl font-bold text-gray-900">PriceOptimizer</h1>
      </div>
      <button
        (click)="logout()"
        class="flex items-center px-4 py-2 text-sm font-medium text-gray-700 hover:text-red-600 transition-colors"
      >
        <svg class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        Sair
      </button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Form Section -->
    <app-card [elevated]="true" class="mb-8">
      <div>
        <h2 class="text-xl font-bold text-gray-900 mb-6">Otimização de Preço</h2>

        @if (errorMessage) {
          <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center">
              <svg class="h-5 w-5 text-red-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <span class="text-sm text-red-800">{{ errorMessage }}</span>
            </div>
          </div>
        }

        <form [formGroup]="optimizationForm" (ngSubmit)="onSubmit()">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left Column: Form Inputs -->
            <div class="space-y-4">
              <!-- Select Optimization -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Selecionar Otimização
                </label>
                <select
                  (change)="onOptimizationSelect($event)"
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white"
                  [disabled]="isLoadingList"
                >
                  <option value="new">+ Adicionar Produto</option>
                  @for (opt of optimizations; track opt.optimization_name) {
                    <option [value]="opt.optimization_name">{{ opt.optimization_name }}</option>
                  }
                </select>
              </div>

              <app-input
                id="productName"
                type="text"
                label="Nome do Produto"
                placeholder="Ex: Notebook Dell"
                formControlName="productName"
                [error]="productNameControl?.touched && productNameControl?.invalid ? getProductNameError() : ''"
                [required]="true"
              ></app-input>

              <app-input
                id="costFunction"
                type="text"
                label="Função de Custo C(q)"
                placeholder="Ex: 100 + 50*q"
                formControlName="costFunction"
                [error]="costFunctionControl?.touched && costFunctionControl?.invalid ? getCostFunctionError() : ''"
                hint="Use 'q' como variável de quantidade"
                [required]="true"
              ></app-input>

              <app-input
                id="demandFunction"
                type="text"
                label="Função de Demanda Q(p)"
                placeholder="Ex: 1000 - 2*p"
                formControlName="demandFunction"
                [error]="demandFunctionControl?.touched && demandFunctionControl?.invalid ? getDemandFunctionError() : ''"
                hint="Use 'p' como variável de preço"
                [required]="true"
              ></app-input>
            </div>

            <!-- Right Column: Instructions -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
              <h3 class="text-lg font-semibold text-blue-900 mb-3">Como usar</h3>
              <ul class="space-y-3 text-sm text-blue-800">
                <li class="flex items-start">
                  <svg class="h-5 w-5 mr-2 flex-shrink-0 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span><strong>Função de Custo:</strong> Expressa o custo total em função da quantidade (q). Ex: 100 + 50*q</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 mr-2 flex-shrink-0 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span><strong>Função de Demanda:</strong> Expressa a quantidade demandada em função do preço (p). Ex: 1000 - 2*p</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 mr-2 flex-shrink-0 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Use operadores matemáticos: +, -, *, /, ** (potência), sqrt(), log(), etc.</span>
                </li>
                <li class="flex items-start">
                  <svg class="h-5 w-5 mr-2 flex-shrink-0 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>O sistema calculará automaticamente o preço ótimo que maximiza o lucro</span>
                </li>
              </ul>
            </div>
          </div>

          <div class="mt-6">
            <app-button
              type="submit"
              variant="primary"
              size="lg"
              [loading]="isLoading"
              [disabled]="optimizationForm.invalid && optimizationForm.touched"
            >
              {{ selectedOptimizationName ? 'Atualizar Otimização' : 'Calcular Otimização' }}
            </app-button>
          </div>
        </form>
      </div>
    </app-card>

    <!-- Results Section -->
    @if (currentResult) {
      <app-card [elevated]="true">
        <div>
          <h2 class="text-xl font-bold text-gray-900 mb-6">Resultados da Otimização</h2>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Optimal Price -->
            <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-6">
              <div class="flex items-center mb-2">
                <svg class="h-6 w-6 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <h3 class="text-lg font-semibold text-green-900">Preço Ótimo</h3>
              </div>
              <p class="text-4xl font-bold text-green-700">R$ {{ currentResult.optimal_price.toFixed(2) }}</p>
            </div>

            <!-- Maximum Profit -->
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-lg p-6">
              <div class="flex items-center mb-2">
                <svg class="h-6 w-6 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                <h3 class="text-lg font-semibold text-blue-900">Lucro Máximo</h3>
              </div>
              <p class="text-4xl font-bold text-blue-700">R$ {{ currentResult.max_profit.toFixed(2) }}</p>
            </div>
          </div>

          <!-- Graph -->
          @if (currentResult.graph_image_url) {
            <div class="border border-gray-200 rounded-lg p-4 bg-white">
              <h3 class="text-lg font-semibold text-gray-900 mb-4">Gráfico de Análise</h3>
              <img 
                [src]="currentResult.graph_image_url" 
                alt="Gráfico de otimização"
                class="w-full h-auto rounded-lg shadow-md"
              />
            </div>
          }
        </div>
      </app-card>
    }

    @if (isLoading) {
      <app-loading-spinner [size]="'lg'" [message]="'Calculando otimização...'"></app-loading-spinner>
    }
  </main>
</div>
